<script>
const STORAGE_KEY = "nms_planets_archive_v1";

// üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ ‚Äì —Å–∞–º–æ –ª–æ–≥–Ω–∞—Ç –∞–¥–º–∏–Ω
if (localStorage.getItem("isAdmin") !== "true") {
  window.location.href = "login.html";
}

function logout() {
  localStorage.removeItem("isAdmin");
  window.location.href = "login.html";
}

let currentImages = [];
const photosInput  = document.getElementById("photos");
const photoPreview = document.getElementById("photoPreview");
const statusEl     = document.getElementById("status");


// ‚≠ê NEW: –∫–æ–º–ø—Ä–µ—Å–∏—Ä–∞–Ω–µ –Ω–∞ —Å–Ω–∏–º–∫–∏ –ø—Ä–µ–¥–∏ –∑–∞–ø–∏—Å
function compressImage(file, maxWidth = 800, quality = 0.7) {
  return new Promise((resolve) => {
    const img = new Image();
    const reader = new FileReader();

    reader.onload = (e) => { img.src = e.target.result; };

    img.onload = () => {
      const canvas = document.createElement("canvas");
      const scale = maxWidth / img.width;
      canvas.width  = maxWidth;
      canvas.height = img.height * scale;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      const compressed = canvas.toDataURL("image/jpeg", quality);
      resolve(compressed);
    };

    reader.readAsDataURL(file);
  });
}


// üì∏ –ü—Ä–µ–≥–ª–µ–¥ + –∫–æ–º–ø—Ä–µ—Å–∏—Ä–∞–Ω–µ
photosInput.addEventListener("change", async function () {
  const files = Array.from(this.files || []);
  currentImages = [];
  photoPreview.innerHTML = "";

  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    if (!file.type.startsWith("image/")) continue;

    // üî• –∫–æ–º–ø—Ä–µ—Å–∏—Ä–∞–º–µ —Å–Ω–∏–º–∫–∞—Ç–∞
    const compressedSrc = await compressImage(file);

    currentImages.push(compressedSrc);

    const box = document.createElement("div");
    box.className = "photo-thumb";
    box.innerHTML = `
      <img src="${compressedSrc}">
      <span>#${i + 1}</span>
    `;
    photoPreview.appendChild(box);
  }
});


// –°—ä–æ–±—â–µ–Ω–∏—è
function setStatus(msg, error = false) {
  statusEl.textContent = msg;
  statusEl.style.color = error ? "var(--danger)" : "var(--success)";
}


// üíæ –ó–ê–ü–ò–° –ù–ê –ü–õ–ê–ù–ï–¢–ê
function savePlanet(e) {
  e.preventDefault();

  let list = [];
  try {
    list = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  } catch {
    setStatus("LocalStorage —Å—ä–¥—ä—Ä–∂–∞ –ø–æ–≤—Ä–µ–¥–µ–Ω–∏ –¥–∞–Ω–Ω–∏!", true);
    return;
  }

  const p = {
    id: Date.now(),
    name:      document.getElementById("name").value.trim(),
    galaxy:    document.getElementById("galaxy").value.trim(),
    system:    document.getElementById("system").value.trim(),
    biome:     document.getElementById("biome").value.trim(),
    weather:   document.getElementById("weather").value.trim(),
    temp:      document.getElementById("temp").value.trim(),
    hazard:    document.getElementById("hazard").value.trim(),
    sentinels: document.getElementById("sentinels").value.trim(),
    fauna:     document.getElementById("fauna").value.trim(),
    flora:     document.getElementById("flora").value.trim(),
    resources: document.getElementById("resources").value.trim(),
    desc:      document.getElementById("desc").value.trim(),
    images:    currentImages.slice(),   // –≤–µ—á–µ –∫–æ–º–ø—Ä–µ—Å–∏—Ä–∞–Ω–∏!
    createdAt: new Date().toISOString()
  };

  if (!p.name) {
    setStatus("–í—ä–≤–µ–¥–∏ –∏–º–µ –Ω–∞ –ø–ª–∞–Ω–µ—Ç–∞—Ç–∞!", true);
    return;
  }

  try {
    list.push(p);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    setStatus("–ü–õ–ê–ù–ï–¢–ê–¢–ê –ï –ó–ê–ü–ê–ó–ï–ù–ê ‚úî (–∫–æ–º–ø—Ä–µ—Å–∏—Ä–∞–Ω–∏ —Å–Ω–∏–º–∫–∏)");

  } catch(err) {
    console.error(err);
    setStatus("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å! –î–∞–Ω–Ω–∏—Ç–µ –Ω–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏!", true);
    list.pop();
  }

  document.getElementById("planetForm").reset();
  currentImages = [];
  photoPreview.innerHTML = "";
}
</script>
