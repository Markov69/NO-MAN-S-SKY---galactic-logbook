<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8">
  <title>NMS Logbook • Planet Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #020513;
      --panel: rgba(4, 12, 30, 0.96);
      --border: rgba(0, 200, 255, 0.7);
      --accent: #4cd8ff;
      --text: #e5f8ff;
      --danger: #ff8080;
      --success: #9effc0;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0; min-height: 100vh;
      background:#020513;
      font-family:"Orbitron",sans-serif;
      display:flex; justify-content:center; align-items:center;
      padding:20px;
      color:var(--text);
    }

    .panel {
      width:min(1080px,100%);
      background:var(--panel);
      border-radius:26px;
      border:1px solid var(--border);
      padding:26px;
      position:relative;
    }

    h1 { text-align:center; margin:0; letter-spacing:0.26em; color:var(--accent); }

    /* Captain */
    .captain-box {
      position:absolute;
      top:45px; right:25px;
      text-align:center;
    }
    .captain-title {
      font-size:10px; letter-spacing:0.12em;
      opacity:0.8; margin-bottom:4px;
    }
    .captain-avatar {
      width:90px; height:90px;
      border-radius:50%;
      object-fit:cover;
      border:2px solid cyan;
      box-shadow:0 0 14px cyan;
    }
    #captainInput { margin-top:6px; font-size:10px; }

    /* Grid */
    .grid {
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:14px;
    }
    label { font-size:10px; letter-spacing:0.15em; opacity:0.85; }
    input, textarea {
      width:100%; padding:8px; border-radius:10px;
      border:1px solid cyan; background:#041020; color:white;
      font-family:inherit; font-size:12px;
    }
    textarea { height:90px; }

    .full { grid-column:1 / -1; }

    /* Photos */
    .photo-preview-wrap {
      display:flex; flex-wrap:wrap; gap:8px;
    }
    .photo-thumb img {
      width:80px; height:80px; object-fit:cover;
      border:1px solid cyan; border-radius:8px;
    }

    /* Buttons */
    .btn-primary {
      margin-top:12px; padding:12px 40px;
      border:2px solid cyan; border-radius:999px;
      background:#06172c; color:cyan;
      letter-spacing:0.2em; font-size:11px;
      cursor:pointer;
    }

    .logout-btn {
      position:absolute; top:12px; right:12px;
      padding:6px 14px; border-radius:999px;
      background:rgba(80,0,0,0.8);
      color:#ffb3b3; border:1px solid #ff6b6b;
      cursor:pointer; font-size:10px;
    }

    .status { text-align:center; margin-top:10px; font-size:11px; }
  </style>
</head>

<body>
<div class="panel">

  <button class="logout-btn" onclick="logout()">LOG OUT</button>

  <div class="captain-box">
    <div class="captain-title">CAPTAIN</div>
    <img id="captainAvatar" class="captain-avatar" src="">
    <input type="file" id="captainInput" accept="image/*">
  </div>

  <h1>PLANET ADMIN</h1>

  <form id="planetForm" class="grid" onsubmit="savePlanet(event)">
    <div><label>PLANET NAME</label><input id="name" required></div>
    <div><label>GALAXY</label><input id="galaxy"></div>
    <div><label>STAR SYSTEM</label><input id="system"></div>

    <div><label>BIOME</label><input id="biome"></div>
    <div><label>WEATHER</label><input id="weather"></div>
    <div><label>TEMP</label><input id="temp"></div>

    <div><label>HAZARD</label><input id="hazard"></div>
    <div><label>SENTINELS</label><input id="sentinels"></div>
    <div><label>FAUNA</label><input id="fauna"></div>

    <div><label>FLORA</label><input id="flora"></div>
    <div class="full"><label>RESOURCES</label><input id="resources"></div>

    <div class="full">
      <label>DESCRIPTION</label>
      <textarea id="desc"></textarea>
    </div>

    <div class="full">
      <label>PHOTOS</label>
      <input type="file" id="photos" accept="image/*" multiple>
    </div>

    <div id="photoPreview" class="photo-preview-wrap full"></div>

    <div class="full" style="text-align:center;">
      <button class="btn-primary" type="submit">SAVE PLANET ENTRY</button>
    </div>

    <div id="status" class="status"></div>
  </form>
</div>

<script src="storage.js"></script>
<script>
// LOGIN
if (localStorage.getItem("isAdmin") !== "true") window.location.href="login.html";
function logout(){ localStorage.removeItem("isAdmin"); window.location.href="login.html"; }

// COMPRESS
function compressImage(file, maxSize=340){
  return new Promise(res=>{
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.src = e.target.result;
      img.onload = () => {
        const c = document.createElement("canvas");
        const ctx = c.getContext("2d");

        let w = img.width, h = img.height;
        const scale = maxSize / Math.max(w,h);
        w*=scale; h*=scale;

        c.width=w; c.height=h;
        ctx.drawImage(img,0,0,w,h);

        res(c.toDataURL("image/jpeg",0.75));
      };
    };
    reader.readAsDataURL(file);
  });
}

// Captain
let captainImage="";
const captainInput=document.getElementById("captainInput");
const captainAvatar=document.getElementById("captainAvatar");

captainInput.addEventListener("change",async()=>{
  if (!captainInput.files.length) return;
  captainImage = await compressImage(captainInput.files[0],240);
  captainAvatar.src = captainImage;
});

// Photos
let planetImages=[];
const photos=document.getElementById("photos");
const preview=document.getElementById("photoPreview");

photos.addEventListener("change",async()=>{
  preview.innerHTML="";
  planetImages=[];
  for(const file of photos.files){
    const small=await compressImage(file);
    planetImages.push(small);
    const box=document.createElement("div");
    box.className="photo-thumb";
    box.innerHTML=`<img src="${small}">`;
    preview.appendChild(box);
  }
});

// SAVE
function savePlanet(e){
  e.preventDefault();

  const entry={
    id:Date.now(),
    name:name.value.trim(),
    galaxy:galaxy.value.trim(),
    system:system.value.trim(),
    biome:biome.value.trim(),
    weather:weather.value.trim(),
    temp:temp.value.trim(),
    hazard:hazard.value.trim(),
    sentinels:sentinels.value.trim(),
    fauna:fauna.value.trim(),
    flora:flora.value.trim(),
    resources:resources.value.trim(),
    desc:desc.value.trim(),
    images:planetImages,
    captain:captainImage,
    createdAt:new Date().toISOString()
  };

  if (!entry.name){
    status.textContent="Името е задължително!";
    status.style.color="var(--danger)";
    return;
  }

  const ok = addPlanet(entry);

  status.textContent = ok ? "✔ Планетата е записана!" : "Грешка при запис!";
  status.style.color = ok ? "var(--success)" : "var(--danger)";

  if(ok){
    planetForm.reset();
    preview.innerHTML="";
    planetImages=[];
  }
}
</script>

</body>
</html>
