<script>
// üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ ‚Äì —Å–∞–º–æ –ª–æ–≥–Ω–∞—Ç –∞–¥–º–∏–Ω
if (localStorage.getItem("isAdmin") !== "true") {
  window.location.href = "login.html";
}

function logout() {
  localStorage.removeItem("isAdmin");
  window.location.href = "login.html";
}

const STORAGE_KEY = "nms_planets_archive_v1";

let currentImages = [];

// –ü—Ä–µ–≥–ª–µ–¥ –Ω–∞ —Å–Ω–∏–º–∫–∏
document.getElementById("photos").addEventListener("change", function () {
  const files = Array.from(this.files || []);
  currentImages = [];
  document.getElementById("photoPreview").innerHTML = "";

  files.forEach((file, index) => {
    if (!file.type.startsWith("image/")) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      const src = e.target.result;
      currentImages.push(src);

      // thumbnail
      const box = document.createElement("div");
      box.className = "photo-thumb";
      box.innerHTML = `
        <img src="${src}">
        <span>#${index + 1}</span>
      `;
      document.getElementById("photoPreview").appendChild(box);
    };
    reader.readAsDataURL(file);
  });
});

function setStatus(msg, error=false){
  const el = document.getElementById("status");
  el.textContent = msg;
  el.style.color = error ? "#ff8080" : "#9effc0";
}

// üî• SAVE PLANET
function savePlanet(e) {
  e.preventDefault();

  let list = [];
  try {
    list = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  } catch {
    setStatus("LocalStorage —Å—ä–¥—ä—Ä–∂–∞ –ø–æ–≤—Ä–µ–¥–µ–Ω–∏ –¥–∞–Ω–Ω–∏!", true);
    return;
  }

  const p = {
    id: Date.now(),
    name: document.getElementById("name").value.trim(),
    galaxy: document.getElementById("galaxy").value.trim(),
    system: document.getElementById("system").value.trim(),
    biome: document.getElementById("biome").value.trim(),
    weather: document.getElementById("weather").value.trim(),
    temp: document.getElementById("temp").value.trim(),
    hazard: document.getElementById("hazard").value.trim(),
    sentinels: document.getElementById("sentinels").value.trim(),
    fauna: document.getElementById("fauna").value.trim(),
    flora: document.getElementById("flora").value.trim(),
    resources: document.getElementById("resources").value.trim(),
    desc: document.getElementById("desc").value.trim(),
    images: currentImages.slice(),
    createdAt: new Date().toISOString()
  };

  if (!p.name){
    setStatus("–í—ä–≤–µ–¥–∏ –∏–º–µ –Ω–∞ –ø–ª–∞–Ω–µ—Ç–∞—Ç–∞!", true);
    return;
  }

  list.push(p);

  // üî• –ü–™–†–í–ò –û–ü–ò–¢: –∑–∞–ø–∏—Å —Å—ä—Å —Å–Ω–∏–º–∫–∏
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    setStatus("–ü–õ–ê–ù–ï–¢–ê–¢–ê –ï –ó–ê–ü–ê–ó–ï–ù–ê ‚úî");
  }
  catch (err1) {
    console.warn("–°–Ω–∏–º–∫–∏—Ç–µ —Å–∞ —Ç–≤—ä—Ä–¥–µ –≥–æ–ª–µ–º–∏ ‚Üí –æ–ø–∏—Ç–∞–º–µ –±–µ–∑ —Å–Ω–∏–º–∫–∏");

    // –æ–ø–∏—Ç 2 –±–µ–∑ —Å–Ω–∏–º–∫–∏
    p.images = [];
    list[list.length - 1] = p;

    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
      setStatus("–ó–∞–ø–∞–∑–µ–Ω–æ, –ë–ï–ó —Å–Ω–∏–º–∫–∏ (—Ç–≤—ä—Ä–¥–µ –≥–æ–ª–µ–º–∏ —Ñ–∞–π–ª–æ–≤–µ)", true);
    }
    catch (err2) {
      console.error(err2);
      setStatus("–ì–†–ï–®–ö–ê –ü–†–ò –ó–ê–ü–ò–°! –î–ê–ù–ù–ò–¢–ï –ù–ï –°–ê –ó–ê–ü–ê–ó–ï–ù–ò!", true);
      list.pop();
      return;
    }
  }

  document.getElementById("planetForm").reset();
  currentImages = [];
  document.getElementById("photoPreview").innerHTML = "";
}
</script>
