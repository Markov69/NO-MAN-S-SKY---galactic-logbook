<script>
  // --- LOGIN GUARD ---
  if (localStorage.getItem("isAdmin") !== "true") {
    window.location.href = "login.html";
  }

  function logout() {
    localStorage.removeItem("isAdmin");
    window.location.href = "login.html";
  }

  const STORAGE_KEY = "nms_planets_archive_v1";
  const statusEl = document.getElementById("status");
  const photoPreview = document.getElementById("photoPreview");
  const planetForm = document.getElementById("planetForm");

  function setStatus(msg, err = false) {
    statusEl.style.color = err ? "var(--danger)" : "var(--success)";
    statusEl.textContent = msg;
  }

  // ---------- CAPTAIN PHOTO ----------
  const captainImg = document.getElementById("captainImg");
  const captainUpload = document.getElementById("captainUpload");

  const savedCaptain = localStorage.getItem("captainPhoto");
  if (savedCaptain) captainImg.src = savedCaptain;

  captainUpload.addEventListener("change", function () {
    const file = this.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
      captainImg.src = e.target.result;
      localStorage.setItem("captainPhoto", e.target.result);
    };
    reader.readAsDataURL(file);
  });

  function removeCaptainPhoto() {
    localStorage.removeItem("captainPhoto");
    captainImg.src = "media/captain.png";
  }

  // ---------- IMAGE COMPRESS ----------
  function compressImage(file, maxW, quality = 0.8) {
    return new Promise(resolve => {
      const img = new Image();
      const reader = new FileReader();

      reader.onload = e => { img.src = e.target.result; };
      reader.readAsDataURL(file);

      img.onload = () => {
        const canvas = document.createElement("canvas");
        const scale = maxW / img.width;
        canvas.width = maxW;
        canvas.height = img.height * scale;

        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        resolve(canvas.toDataURL("image/jpeg", quality));
      };
    });
  }

  // ---------- PLANET PHOTOS PREVIEW ----------
  const selectedPlanetPhotos = [];

  document.getElementById("photos").addEventListener("change", async function () {
    photoPreview.innerHTML = "";
    selectedPlanetPhotos.length = 0;

    for (let file of this.files) {
      const dataUrl = await compressImage(file, 700, 0.7);
      selectedPlanetPhotos.push(dataUrl);

      const div = document.createElement("div");
      div.className = "photo-thumb";
      div.innerHTML = `<img src="${dataUrl}" alt="">`;
      photoPreview.appendChild(div);
    }
  });

  // ---------- ENTRY CARDS ----------
  function addEntryCard(listId) {
    const list = document.getElementById(listId);

    const card = document.createElement("div");
    card.className = "entry-card";
    card.dataset.img = "";

    const imgId = "img_" + Math.random().toString(36).slice(2);
    const fileId = "file_" + Math.random().toString(36).slice(2);

    card.innerHTML = `
      <div class="entry-thumb" onclick="openLightboxFromThumb('${imgId}')">
        <img id="${imgId}" src="media/captain.png">
      </div>
      <div class="entry-main">
        <input type="text" class="entry-name" placeholder="Name / Type">
        <textarea class="entry-desc" placeholder="Short description..."></textarea>
      </div>
      <div class="entry-actions">
        <input type="file" id="${fileId}" accept="image/*" style="display:none;">
        <button type="button" class="btn-entry-upload" onclick="document.getElementById('${fileId}').click()">Upload</button>
        <button type="button" class="btn-entry-remove" onclick="this.closest('.entry-card').remove()">Remove</button>
      </div>
    `;

    list.appendChild(card);

    const fileInput = card.querySelector("#" + fileId);
    const imgEl = card.querySelector("#" + imgId);

    fileInput.addEventListener("change", async function () {
      const file = this.files[0];
      if (!file) return;
      const dataUrl = await compressImage(file, 700, 0.7);
      imgEl.src = dataUrl;
      card.dataset.img = dataUrl;
    });
  }

  // ---------- LIGHTBOX ----------
  const lightbox = document.getElementById("lightbox");
  const lightboxImg = document.getElementById("lightboxImg");

  function openLightboxFromThumb(imgId) {
    const img = document.getElementById(imgId);
    if (!img) return;
    lightboxImg.src = img.src;
    lightbox.style.display = "flex";
  }

  function closeLightbox() {
    lightbox.style.display = "none";
  }

  // ---------- COLLECT ENTRIES ----------
  function collectEntries(listId) {
    const list = document.getElementById(listId);
    const cards = list.querySelectorAll(".entry-card");
    return Array.from(cards).map(card => ({
      name: card.querySelector(".entry-name").value.trim(),
      desc: card.querySelector(".entry-desc").value.trim(),
      img: card.dataset.img || "media/captain.png"
    }));
  }

  // ---------- SAVE PLANET ----------
  function savePlanet(e) {
    e.preventDefault();

    let list = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");

    const p = {
      id: Date.now(),
      name: name.value.trim(),
      galaxy: galaxy.value.trim(),
      system: system.value.trim(),
      biome: biome.value.trim(),
      weather: weather.value.trim(),
      temp: temp.value.trim(),
      hazard: hazard.value.trim(),
      floraCount: floraCount.value.trim(),
      faunaCount: faunaCount.value.trim(),
      resourcesSummary: resourcesSummary.value.trim(),
      desc: desc.value.trim(),
      animals: collectEntries("animalsList"),
      plants: collectEntries("plantsList"),
      resourcesDetailed: collectEntries("resourcesList"),
      hazardsDetailed: collectEntries("hazardsList"),
      images: selectedPlanetPhotos,
      createdAt: new Date().toISOString()
    };

    if (!p.name) {
      setStatus("Missing planet name!", true);
      return;
    }

    list.push(p);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(list));

    setStatus("Saved âœ”");

    planetForm.reset();
    photoPreview.innerHTML = "";
    selectedPlanetPhotos.length = 0;

    document.getElementById("animalsList").innerHTML = "";
    document.getElementById("plantsList").innerHTML = "";
    document.getElementById("resourcesList").innerHTML = "";
    document.getElementById("hazardsList").innerHTML = "";
  }
</script>
