<script>
const STORAGE_KEY = "nms_planets_archive_v1";

function loadPlanets() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : [];
  } catch (e) {
    console.warn("Bad JSON:", e);
    return [];
  }
}

function savePlanets(list) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
}

function formatDate(iso) {
  if (!iso) return "";
  return new Date(iso).toLocaleString("bg-BG");
}

// ðŸ”¥ DELETE FUNCTION
function deletePlanet(id) {
  if (!confirm("Ð¡Ð¸Ð³ÑƒÑ€ÐµÐ½ Ð»Ð¸ ÑÐ¸, Ñ‡Ðµ Ð¸ÑÐºÐ°Ñˆ Ð´Ð° Ð¸Ð·Ñ‚Ñ€Ð¸ÐµÑˆ Ñ‚Ð¾Ð·Ð¸ Ð·Ð°Ð¿Ð¸Ñ?")) return;
  let all = loadPlanets();
  all = all.filter(p => p.id !== id);
  savePlanets(all);
  render();
}

// ðŸ” SHOW FULL IMAGE
function showImage(src) {
  document.getElementById("overlayImg").src = src;
  document.getElementById("imgOverlay").style.display = "flex";
}

function closeOverlay() {
  document.getElementById("imgOverlay").style.display = "none";
}

// ðŸ”µ RENDER ARCHIVE
function render() {
  const cardsEl = document.getElementById("cards");
  const emptyEl = document.getElementById("empty");
  const planets = loadPlanets();

  cardsEl.innerHTML = "";

  if (!planets.length) {
    emptyEl.style.display = "block";
    return;
  }
  emptyEl.style.display = "none";

  planets
    .slice()
    .sort((a, b) => (b.createdAt || "").localeCompare(a.createdAt || ""))
    .forEach(p => {

      const images = Array.isArray(p.images) ? p.images : [];

      let thumbs = "";
      if (images.length > 0) {
        thumbs = `
          <div class="thumb-area">
            ${images.map((src, index) => `
                <div class="thumb" onclick="showImage('${src}')">
                  <img src="${src}">
                  <span class="thumb-count">#${index + 1}</span>
                </div>
            `).join("")}
          </div>
        `;
      }

      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <div class="planet-name">${p.name}</div>
        <div class="badge-line">
          <span>${p.galaxy || "-"} â€¢ ${p.system || "-"}</span>
          <span class="badge">${p.biome || "-"}</span>
        </div>

        <div class="row">Weather: <span>${p.weather || "-"}</span></div>
        <div class="row">Temperature: <span>${p.temp || "-"}</span></div>
        <div class="row">Hazards: <span>${p.hazard || "-"}</span></div>
        <div class="row">Sentinels: <span>${p.sentinels || "-"}</span></div>
        <div class="row">Fauna: <span>${p.fauna || "-"}</span></div>
        <div class="row">Flora: <span>${p.flora || "-"}</span></div>
        <div class="row">Resources: <span>${p.resources || "-"}</span></div>
        <div class="row">Log date: <span>${formatDate(p.createdAt)}</span></div>

        <div class="desc">${(p.desc || "").replace(/\n/g, "<br>")}</div>

        ${thumbs}

        <button onclick="deletePlanet(${p.id})"
          style="
            margin-top:12px;
            padding:6px 14px;
            border-radius:8px;
            background:#380000;
            color:#ffb3b3;
            border:1px solid #ff6b6b;
            cursor:pointer;
            text-transform:uppercase;
            font-size:10px;
            letter-spacing:0.14em;
          ">
          DELETE ENTRY
        </button>
      `;

      cardsEl.appendChild(card);
    });
}

render();
</script>
